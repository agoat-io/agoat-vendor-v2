<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post</title>
    <script src="https://unpkg.com/@hotwired/turbo@7/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/alpinejs@3/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200" x-data="postEditor()">
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a href="/admin" class="btn btn-ghost text-xl">← Back to Dashboard</a>
        </div>
        <div class="flex-none gap-2">
            <div class="badge badge-outline" x-text="`${wordCount} words`"></div>
            <button @click="saveDraft()" class="btn btn-ghost btn-sm">Save Draft</button>
            <button @click="savePost()" class="btn btn-primary btn-sm">
                <span x-show="!published">Save as Draft</span>
                <span x-show="published">Publish</span>
            </button>
        </div>
    </div>
    
    <div class="container mx-auto mt-8 px-4 max-w-6xl">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Editor Panel -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">Create New Post</h2>
                    
                    <form id="post-form" @submit.prevent="savePost">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Title</span>
                            </label>
                            <input type="text" x-model="title" @input="generateSlug()"
                                   placeholder="Enter post title" 
                                   class="input input-bordered" required>
                        </div>
                        
                        <div class="form-control mt-4">
                            <label class="label">
                                <span class="label-text">Slug</span>
                            </label>
                            <input type="text" x-model="slug" 
                                   placeholder="post-url-slug" 
                                   class="input input-bordered input-sm" readonly>
                        </div>
                        
                        <div class="form-control mt-4">
                            <label class="label">
                                <span class="label-text">Content</span>
                                <span class="label-text-alt">Markdown supported</span>
                            </label>
                            <textarea x-model="content" @input="updateWordCount()"
                                      placeholder="Write your post content here..." 
                                      class="textarea textarea-bordered h-64" required></textarea>
                        </div>
                        
                        <div class="form-control mt-4">
                            <label class="label cursor-pointer">
                                <span class="label-text">Publish immediately</span>
                                <input type="checkbox" x-model="published" 
                                       class="checkbox checkbox-primary">
                            </label>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Live Preview Panel -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">Live Preview</h2>
                    
                    <div class="mockup-window border bg-base-300">
                        <div class="px-4 py-8 bg-base-200 h-96 overflow-y-auto">
                            <article class="prose max-w-none">
                                <h1 x-text="title || 'Post Title'"></h1>
                                <div class="text-sm text-base-content/60 mb-4">
                                    <span>By Admin</span> • 
                                    <span x-text="new Date().toLocaleDateString()"></span>
                                </div>
                                <div x-html="renderMarkdown(content)"></div>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Auto-save indicator -->
        <div x-show="autoSaved" x-transition 
             class="toast toast-top toast-end">
            <div class="alert alert-success">
                <span>Draft auto-saved</span>
            </div>
        </div>
    </div>
    
    <script>
        function postEditor() {
            return {
                title: '',
                slug: '',
                content: '',
                published: false,
                wordCount: 0,
                autoSaved: false,
                autoSaveTimer: null,
                
                init() {
                    // Load draft from session storage
                    this.loadDraft();
                    
                    // Auto-save every 30 seconds
                    this.autoSaveTimer = setInterval(() => {
                        if (this.title || this.content) {
                            this.saveDraft();
                        }
                    }, 30000);
                    
                    // Update word count
                    this.updateWordCount();
                },
                
                generateSlug() {
                    this.slug = this.title
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                },
                
                updateWordCount() {
                    this.wordCount = this.content.split(/\s+/).filter(w => w.length > 0).length;
                },
                
                renderMarkdown(content) {
                    // Basic markdown rendering
                    return content
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>');
                },
                
                saveDraft() {
                    const draft = {
                        title: this.title,
                        content: this.content,
                        slug: this.slug,
                        published: this.published,
                        timestamp: new Date().toISOString()
                    };
                    sessionStorage.setItem('post-draft', JSON.stringify(draft));
                    
                    // Show indicator
                    this.autoSaved = true;
                    setTimeout(() => {
                        this.autoSaved = false;
                    }, 3000);
                    
                    // Emit event
                    window.eventBus.emit('draft-saved', draft);
                },
                
                loadDraft() {
                    const draft = sessionStorage.getItem('post-draft');
                    if (draft) {
                        const data = JSON.parse(draft);
                        this.title = data.title || '';
                        this.content = data.content || '';
                        this.slug = data.slug || '';
                        this.published = data.published || false;
                    }
                },
                
                async savePost() {
                    const formData = new FormData();
                    formData.append('title', this.title);
                    formData.append('content', this.content);
                    formData.append('published', this.published ? 'on' : '');
                    
                    try {
                        const response = await fetch('/admin/posts/new', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            // Clear draft
                            sessionStorage.removeItem('post-draft');
                            
                            // Emit event
                            window.eventBus.emit('post-created', {
                                title: this.title,
                                published: this.published
                            });
                            
                            // Redirect with Turbo
                            setTimeout(() => {
                                Turbo.visit('/admin');
                            }, 500);
                        } else {
                            alert('Error saving post');
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                        alert('Error saving post');
                    }
                },
                
                destroy() {
                    // Clean up timer
                    if (this.autoSaveTimer) {
                        clearInterval(this.autoSaveTimer);
                    }
                }
            }
        }
        
        // Initialize event bus
        window.eventBus = window.eventBus || {
            events: {},
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            },
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(callback => callback(data));
                }
            }
        };
    </script>
</body>
</html>