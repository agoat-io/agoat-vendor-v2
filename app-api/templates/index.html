<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script src="https://unpkg.com/@hotwired/turbo@7/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/@hotwired/stimulus@3/dist/stimulus.umd.js"></script>
    <script src="https://unpkg.com/alpinejs@3/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200" x-data="blogApp()">
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost text-xl">✨ Modern Blog</a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="/">Home</a></li>
                <li><a href="/admin">Admin</a></li>
                <li><a href="/login">Login</a></li>
            </ul>
        </div>
    </div>
    
    <div class="container mx-auto mt-8 px-4">
        <div class="hero bg-gradient-to-r from-primary to-secondary text-primary-content rounded-lg shadow-xl mb-8">
            <div class="hero-content text-center py-12">
                <div class="max-w-md">
                    <h1 class="text-5xl font-bold">Welcome to Our Blog</h1>
                    <p class="py-6">Discover amazing stories and insights</p>
                    {{if .APIEnabled}}
                    <div class="badge badge-info">API Enabled</div>
                    {{end}}
                </div>
            </div>
        </div>
        
        <div class="grid gap-6" id="posts-list" data-turbo-permanent>
            {{range .Posts}}
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300" 
                 x-data="{ expanded: false }"
                 data-post-id="{{.ID}}">
                <div class="card-body">
                    <h2 class="card-title text-2xl">{{.Title}}</h2>
                    <div class="flex items-center gap-2 text-sm text-base-content/70">
                        <span class="badge badge-ghost">{{.Author}}</span>
                        <span>•</span>
                        <time>{{.CreatedAt.Format "Jan 2, 2006"}}</time>
                        {{if .Published}}
                        <span class="badge badge-success badge-sm">Published</span>
                        {{else}}
                        <span class="badge badge-warning badge-sm">Draft</span>
                        {{end}}
                    </div>
                    <div class="prose max-w-none mt-4" x-show="!expanded" x-transition>
                        <p>{{printf "%.200s" .Content}}...</p>
                    </div>
                    <div class="prose max-w-none mt-4" x-show="expanded" x-transition>
                        {{.Content}}
                    </div>
                    <div class="card-actions justify-between mt-4">
                        <button @click="expanded = !expanded" 
                                class="btn btn-sm btn-ghost">
                            <span x-text="expanded ? '▲ Show less' : '▼ Read more'"></span>
                        </button>
                        <a href="/posts/{{.Slug}}" class="btn btn-sm btn-primary">
                            View Full Post →
                        </a>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        
        {{if not .Posts}}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center">
                <h2 class="card-title justify-center">No posts yet</h2>
                <p>Check back soon for new content!</p>
            </div>
        </div>
        {{end}}
    </div>
    
    <script>
        // Alpine.js component for blog functionality
        function blogApp() {
            return {
                posts: [],
                apiEnabled: {{.APIEnabled}},
                
                init() {
                    // Subscribe to server events
                    this.connectToEventStream();
                    
                    // Initialize event bus
                    window.eventBus.on('post-created', (post) => {
                        Turbo.visit(window.location.href);
                    });
                },
                
                connectToEventStream() {
                    if (typeof EventSource !== 'undefined') {
                        const source = new EventSource('/ws');
                        
                        source.onmessage = (e) => {
                            const data = JSON.parse(e.data);
                            window.eventBus.emit('server-update', data);
                        };
                        
                        source.onerror = (e) => {
                            console.error('EventSource error:', e);
                            setTimeout(() => this.connectToEventStream(), 5000);
                        };
                    }
                },
                
                async fetchPosts() {
                    if (!this.apiEnabled) return;
                    
                    try {
                        const response = await fetch('/api/posts');
                        const data = await response.json();
                        if (data.success) {
                            this.posts = data.data;
                        }
                    } catch (error) {
                        console.error('Error fetching posts:', error);
                    }
                }
            }
        }
        
        // Event bus for micro-frontend islands communication
        window.eventBus = {
            events: {},
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            },
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(callback => callback(data));
                }
            },
            off(event, callback) {
                if (this.events[event]) {
                    this.events[event] = this.events[event].filter(cb => cb !== callback);
                }
            }
        };
    </script>
</body>
</html>